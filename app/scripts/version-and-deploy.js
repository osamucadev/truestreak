// app/scripts/version-and-deploy.js
import { readFileSync, writeFileSync } from "fs";
import { execSync } from "child_process";
import { createInterface } from "readline";
import { fileURLToPath } from "url";
import { dirname, join } from "path";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// FunÃ§Ã£o para criar prompt interativo
function prompt(question) {
  const rl = createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  return new Promise((resolve) => {
    rl.question(question, (answer) => {
      rl.close();
      resolve(answer.toLowerCase().trim());
    });
  });
}

// FunÃ§Ã£o para incrementar versÃ£o
function incrementVersion(currentVersion, type) {
  const parts = currentVersion.split(".").map(Number);

  switch (type) {
    case "major":
      return `${parts[0] + 1}.0.0`;
    case "minor":
      return `${parts[0]}.${parts[1] + 1}.0`;
    case "patch":
      return `${parts[0]}.${parts[1]}.${parts[2] + 1}`;
    default:
      throw new Error("Tipo de versÃ£o invÃ¡lido");
  }
}

async function main() {
  console.log("\nğŸš€ TrueStreak - Versionamento e Deploy Automatizado\n");

  // Ler package.json
  const packageJsonPath = join(__dirname, "..", "package.json");
  const packageJson = JSON.parse(readFileSync(packageJsonPath, "utf-8"));
  const currentVersion = packageJson.version;

  console.log(`ğŸ“¦ VersÃ£o atual: v${currentVersion}\n`);
  console.log("Selecione o tipo de versÃ£o:");
  console.log("  [1] patch  - Bug fixes (1.0.0 â†’ 1.0.1)");
  console.log("  [2] minor  - Novas features (1.0.0 â†’ 1.1.0)");
  console.log("  [3] major  - Breaking changes (1.0.0 â†’ 2.0.0)");
  console.log("  [c] cancelar\n");

  const choice = await prompt("Digite sua escolha [1/2/3/c]: ");

  let versionType;
  switch (choice) {
    case "1":
    case "patch":
      versionType = "patch";
      break;
    case "2":
    case "minor":
      versionType = "minor";
      break;
    case "3":
    case "major":
      versionType = "major";
      break;
    case "c":
    case "cancelar":
      console.log("\nâŒ Deploy cancelado.\n");
      process.exit(0);
    default:
      console.log("\nâŒ OpÃ§Ã£o invÃ¡lida. Deploy cancelado.\n");
      process.exit(1);
  }

  const newVersion = incrementVersion(currentVersion, versionType);

  console.log(`\nâœ¨ Nova versÃ£o serÃ¡: v${newVersion}`);
  const confirm = await prompt("Confirmar? [s/n]: ");

  if (
    confirm !== "s" &&
    confirm !== "sim" &&
    confirm !== "y" &&
    confirm !== "yes"
  ) {
    console.log("\nâŒ Deploy cancelado.\n");
    process.exit(0);
  }

  console.log("\nğŸ“ Atualizando arquivos...\n");

  // 1. Atualizar package.json
  packageJson.version = newVersion;
  writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2) + "\n");
  console.log(`   âœ“ package.json atualizado para v${newVersion}`);

  // 2. Criar/atualizar src/version.js
  const versionFilePath = join(__dirname, "..", "src", "version.js");
  const versionFileContent = `// Auto-generated by version-and-deploy.js
// DO NOT EDIT MANUALLY
export const APP_VERSION = "${newVersion}";
`;

  writeFileSync(versionFilePath, versionFileContent);
  console.log(`   âœ“ src/version.js atualizado para v${newVersion}`);

  // 3. Fazer commit das mudanÃ§as
  try {
    console.log("\nğŸ“¦ Criando commit...\n");
    execSync("git add package.json src/version.js", { stdio: "inherit" });
    execSync(`git commit -m "chore: bump version to v${newVersion}"`, {
      stdio: "inherit",
    });
    console.log(`   âœ“ Commit criado: "chore: bump version to v${newVersion}"`);
  } catch (error) {
    console.log("   âš ï¸  Erro ao criar commit (pode nÃ£o ter mudanÃ§as)");
  }

  // 4. Build
  console.log("\nğŸ”¨ Executando build...\n");
  execSync("npm run build", { stdio: "inherit" });
  console.log("   âœ“ Build concluÃ­do");

  // 5. Deploy
  console.log("\nğŸš€ Iniciando deploy...\n");
  execSync("npm run deploy:firebase", { stdio: "inherit" });

  console.log(`\nâœ… Deploy concluÃ­do com sucesso!`);
  console.log(`ğŸ“± App atualizado para v${newVersion}\n`);
}

main().catch((error) => {
  console.error("\nâŒ Erro:", error.message);
  process.exit(1);
});
